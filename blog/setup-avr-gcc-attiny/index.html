<!doctype html><html lang=en><head><title>Setup avr-gcc for the new ATtiny 0/1/2 series :: noxet</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A tutorial on how to set up avr-gcc toolchain for development on the new ATtiny series of microcontrollers"><meta name=keywords content="attiny,microchip,avr,c,c++,embedded,mcu,microcontrollers"><meta name=robots content="noodp"><link rel=canonical href=https://noxet.se/blog/setup-avr-gcc-attiny/><script src=https://kit.fontawesome.com/9d7704afb1.js crossorigin=anonymous></script><link rel=stylesheet href=https://noxet.se/assets/style.css><link rel=stylesheet href=https://noxet.se/style.css><link rel=apple-touch-icon href=https://noxet.se/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://noxet.se/img/favicon/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Setup avr-gcc for the new ATtiny 0/1/2 series"><meta property="og:description" content="A tutorial on how to set up avr-gcc toolchain for development on the new ATtiny series of microcontrollers"><meta property="og:url" content="https://noxet.se/blog/setup-avr-gcc-attiny/"><meta property="og:site_name" content="noxet"><meta property="og:image" content="https://noxet.se/img/favicon/orange.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-08-05 00:32:54 +0200 +0200"></head><body class=orange><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Jonathan Sönnerup</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/music>Music</a></li><li><a href=/projects>Projects</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/music>Music</a></li><li><a href=/projects>Projects</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://noxet.se/blog/setup-avr-gcc-attiny/>Setup avr-gcc for the new ATtiny 0/1/2 series</a></h1><div class=post-meta><span class=post-date>2023-08-05
</span><span class=post-reading-time>:: 3 min read (594 words)</span></div><div class=post-content><div><h1 id=background>Background<a href=#background class=hanchor arialabel=Anchor>&#8983;</a></h1><p>The new ATtiny series is a nice addition to the AVR family.
However, it is not as trivial to just run avr-gcc as usual and believe that stuff
will just&mldr; work&mldr; that would be all too easy :)</p><p>Here, I describe my own journey trying to get all this stuff working, so that I can use the toolchain and
development setup I have always used.</p><h1 id=set-up-the-toolchain>Set up the toolchain<a href=#set-up-the-toolchain class=hanchor arialabel=Anchor>&#8983;</a></h1><p>If you are using the latest Microchip (Atmel) Studio or MPLAB, everything should already be set up to work without further
adjustments.</p><p>This post is about how to set up the AVR GCC toolchain along with avrdude.</p><h2 id=compiler-and-libc>Compiler and libc<a href=#compiler-and-libc class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Just using avr-gcc (and its avr-libc) proved to be a bit more painful (running on macOS 13.1).
The avr-gcc from <code>brew</code> (verion 9.3.0 at the time of writing) does not contain <code>libc.a</code> and <code>libm.a</code> which is needed
by the linker. Therefore as a starting point:</p><ul><li>Download the <a href=https://www.microchip.com/en-us/tools-resources/develop/microchip-studio/gcc-compilers>latest toolchain</a> from Microchip (avr-gcc 7.3.0)</li><li>Extract it to a good location</li><li>Set the PATH variable to point to &lt;install folder>/bin, which contains all tools.</li></ul><p>The included libc (from Microchip) did not contain information about the new series of ATtinys except for the 1-series. This is confirmed when trying
to compile a simple &ldquo;hello world&rdquo; program:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>&gt; avr-gcc -mmcu<span style=color:#f92672>=</span>attiny402 main.c
</span></span><span style=display:flex><span>avr/io.h:581:6: warning: <span style=color:#75715e>#warning &#34;device type not defined&#34;</span>
</span></span></code></pre></div><p>What this means is that the included <code>io.h</code> file does not have a definition for the MCU, attiny402 in this case.</p><p>To resolve this issue, we can download the <a href=https://packs.download.microchip.com/>device support pack</a> from Microchip.
In this case, I downloaded the support pack for the ATtiny series.
Even though the file extension is <code>.atpack</code> it is actually a zip file, so go ahead and extract it.</p><p>Now we can copy the missing files to the installation folder of <code>avr-gcc</code>.</p><ul><li>The device-specific header files included by <code>avr/io.h</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp include/avr/iotn* &lt;install folder&gt;/avr/include/avr/
</span></span></code></pre></div><ul><li>The C-runtime library:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp gcc/dev/attiny*/avrxmega3/*.<span style=color:#f92672>{</span>a,o<span style=color:#f92672>}</span> &lt;install folder&gt;/avr/lib/avrxmega3/
</span></span></code></pre></div><ul><li>The C-runtime library for MCUs with under 8k memory (using short-call instructions):</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp gcc/dev/attiny*/avrxmega3/short-calls/*.<span style=color:#f92672>{</span>a,o<span style=color:#f92672>}</span> &lt;install folder&gt;/avr/lib/avrxmega3/short-calls
</span></span></code></pre></div><ul><li>The device specifications used by the compiler:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp attiny*/device-specs/* &lt;install folder&gt;/lib/gcc/avr/7.3.0/device-specs
</span></span></code></pre></div><p><em>Note</em> that I ran this commands in <code>zsh</code>, so the wildcards might not work for you. Worst case, you have to copy them
manually, either all or just the ones you need.</p><p>Finally, we need to update <code>avr/io.h</code> to include the correct headers, by adding defines and includes for out target
MCUs:</p><ul><li>Either do it manually, following the structure of the header file, adding the new MCUs you want</li><li>or, download my <a href=/io.h>header file</a> and replace the current one (<code>&lt;install folder>/avr/include/avr/io.h</code>)</li></ul><h1 id=building-hello-world>Building hello world<a href=#building-hello-world class=hanchor arialabel=Anchor>&#8983;</a></h1><p>To verify that our setup actually works, let&rsquo;s create a simple hello world program and compile it.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define F_CPU 20000000ULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;avr/io.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;util/delay.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// configure clock, and disable prescaler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CCP <span style=color:#f92672>=</span> CCP_IOREG_gc;
</span></span><span style=display:flex><span>    CLKCTRL.MCLKCTRLB <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// setup LED pin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    PORTA.DIRSET <span style=color:#f92672>=</span> PIN2_bm;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        PORTA.OUTSET <span style=color:#f92672>=</span> PIN2_bm;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_delay_ms</span>(<span style=color:#ae81ff>500</span>);
</span></span><span style=display:flex><span>        PORTA.OUTCLR <span style=color:#f92672>=</span> PIN2_bm;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_delay_ms</span>(<span style=color:#ae81ff>500</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Compile with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>avr-gcc --mmcu<span style=color:#f92672>=</span>attiny402 -O2 main.c -o main.elf
</span></span></code></pre></div><p>We can check the section sizes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>&gt; avr-size main.elf
</span></span><span style=display:flex><span>   text	   data	    bss	    dec	    hex	filename
</span></span><span style=display:flex><span>    140	      0	      0	    140	     8c	main.elf
</span></span></code></pre></div><p>We can also generate then hex file used for flashing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>&gt; avr-objcopy -j .data -j .text -O ihex main.elf main.hex
</span></span></code></pre></div><p>That&rsquo;s it!
You should now have a fully working toolchain for the latest MCUs.</p><p>Check out the coming posts about setting up avrdude, and how to build your own UPDI programmer.</p></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>&copy; 2024 Jonathan Sönnerup</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://noxet.se/assets/main.js></script><script src=https://noxet.se/assets/prism.js></script></div></body></html>